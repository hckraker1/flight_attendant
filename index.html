<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§Ø¶Ø±Ø© Ù‚Ø³Ù… Ø§Ù„Ø¶ÙŠØ§ÙØ© Ø§Ù„Ø¬ÙˆÙŠØ© - Ø§ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø³ÙƒØ§ÙŠ Ø§ÙŠØ¬Ù„Ø²</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; user-select: none; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; text-align: center; }
        .header .academy { font-size: 1.4em; font-weight: bold; margin: 10px 0; }
        .header h1 { font-size: 2.5em; margin: 15px 0; }
        .header .cap { font-size: 1.2em; font-weight: bold; }
        .header .supervisor { font-size: 1.2em; font-weight: bold; color: #ffffff; }
        .content { padding: 40px; }
        .section { display: none; }
        .section.active { display: block; }
        .timer-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; }
        .timer { font-size: 2em; font-weight: bold; }
        .timer.warning { color: #ffeb3b; animation: blink 1s infinite; }
        .timer.danger { color: #f44336; animation: blink 0.5s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.5; } }
        .progress { text-align: center; color: #667eea; font-weight: bold; margin-bottom: 20px; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s; }
        .quiz-question { background: #f8f9ff; border-right: 4px solid #667eea; padding: 25px; margin-bottom: 25px; border-radius: 10px; }
        .quiz-question h3 { color: #667eea; margin-bottom: 20px; font-size: 1.1em; }
        .question-type { font-size: 0.9em; color: #764ba2; font-weight: bold; margin-bottom: 10px; }
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option { padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .option:hover:not(.disabled) { border-color: #667eea; background: #f0f2ff; }
        .option.correct { border-color: #4caf50; background: #4caf50; color: white; }
        .option.incorrect { border-color: #f44336; background: #f44336; color: white; }
        .option.disabled { cursor: not-allowed; opacity: 0.7; }
        .nav-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 40px; }
        button { padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .score-board { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; text-align: center; margin: 20px 0; }
        .start-screen { text-align: center; }
        .start-screen h2 { color: #667eea; margin: 20px 0; }
        .info-box { background: #e3f2fd; border-right: 4px solid #667eea; padding: 20px; border-radius: 8px; margin: 20px 0; }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; }
        .login-form { max-width: 400px; margin: 0 auto; }
        .student-info { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .teacher-panel { text-align: center; }
        .student-list { margin-top: 30px; }
        .student-card { background: #f8f9ff; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-right: 4px solid #667eea; }
        .active-student-card { border-left: 4px solid #ff4757; background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%); }
        .active-student-card h4 { color: #ff4757; }
        .student-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9ff; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-box h3 { color: #667eea; margin-bottom: 10px; }
        .stat-box .number { font-size: 2em; font-weight: bold; }
        .error-message { color: #f44336; margin-top: 5px; font-size: 0.9em; }
        .active-students-section { margin: 30px 0; }
        .teacher-session-info { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; }
        .no-data { text-align: center; color: #666; padding: 40px; font-size: 1.1em; }
        .debug-info { background: #f8f9ff; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="academy">Ø§ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø³ÙƒØ§ÙŠ Ø§ÙŠØ¬Ù„Ø²</div>
            <h1>âœˆï¸ Ø§Ù…ØªØ­Ø§Ù† Ø¹Ø§Ù„Ù… Ø§Ù„Ø·ÙŠØ±Ø§Ù†</h1>
            <div class="academy">Ù‚Ø³Ù… Ø§Ù„Ø¶ÙŠØ§ÙØ© Ø§Ù„Ø¬ÙˆÙŠØ©</div>
            <p style="margin-top: 15px; font-size: 0.95em;">30 Ø³Ø¤Ø§Ù„ - 30 Ø¯Ù‚ÙŠÙ‚Ø©</p>
            <div class="cap">CAP: Peter</div>
            <div class="supervisor">ØªØ­Øª Ø§Ø´Ø±Ø§Ù: Cop: Basmala</div>
        </div>
        
        <div class="content">
            <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
            <div id="studentRegistration" class="section active">
                <div class="start-screen">
                    <h2>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                    <div class="info-box">
                        <strong>ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</strong>
                        <div style="margin-top: 10px;">âœ“ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
                        <div>âœ“ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙƒØ±Ø±</div>
                    </div>
                    <div class="login-form">
                        <div class="form-group">
                            <label for="studentName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                            <input type="text" id="studentName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                            <div id="nameError" class="error-message" style="display: none;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
                        </div>
                        <div class="form-group">
                            <label for="examNumber">Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</label>
                            <input type="number" id="examNumber" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†">
                            <div id="numberError" class="error-message" style="display: none;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù…ØªØ­Ø§Ù† ØµØ­ÙŠØ­</div>
                            <div id="duplicateError" class="error-message" style="display: none;">Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹</div>
                        </div>
                        <div class="nav-buttons">
                            <button class="btn-primary" onclick="registerStudent()">ØªØ³Ø¬ÙŠÙ„ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
                        </div>
                    </div>
                    <div class="nav-buttons">
                        <button class="btn-secondary" onclick="showSection('teacherLogin')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³</button>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ -->
            <div id="teacherLogin" class="section">
                <div class="start-screen">
                    <h2>ğŸ‘¨â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³</h2>
                    <div class="login-form">
                        <div class="form-group">
                            <label for="teacherUsername">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                            <input type="text" id="teacherUsername" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                        </div>
                        <div class="form-group">
                            <label for="teacherPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                            <input type="password" id="teacherPassword" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                        </div>
                        <div class="nav-buttons">
                            <button class="btn-primary" onclick="teacherLogin()">Ø¯Ø®ÙˆÙ„</button>
                            <button class="btn-secondary" onclick="showSection('studentRegistration')">Ø±Ø¬ÙˆØ¹</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³ -->
            <div id="teacherPanel" class="section">
                <div class="teacher-panel">
                    <h2>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯Ø±Ø³</h2>

                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ -->
                    <div class="teacher-session-info">
                        <h3>ğŸ‘¨â€ğŸ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
                        <p><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> <span id="teacherLastUpdate">-</span></p>
                        <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</strong> <span id="connectionStatus" style="color: #4caf50;">â— Ù…ØªØµÙ„</span></p>
                    </div>

                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ -->
                    <div class="debug-info">
                        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­:</strong><br>
                        <span id="debugInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                            <div class="number" id="totalStudents">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                            <div class="number" id="averageScore">0%</div>
                        </div>
                        <div class="stat-box">
                            <h3>Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©</h3>
                            <div class="number" id="highestScore">0%</div>
                        </div>
                        <div class="stat-box">
                            <h3>Ø£Ù‚Ù„ Ù†ØªÙŠØ¬Ø©</h3>
                            <div class="number" id="lowestScore">0%</div>
                        </div>
                    </div>

                    <div class="nav-buttons">
                        <button class="btn-warning" onclick="exportData()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        <button class="btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        <button class="btn-success" onclick="refreshActiveStudents()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</button>
                        <button class="btn-primary" onclick="startAutoRefresh()">ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                    </div>

                    <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ† -->
                    <div class="active-students-section">
                        <h3>ğŸ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ <span id="activeStudentsCount">(0)</span></h3>
                        <div id="activeStudentsList" class="no-data">
                            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†...
                        </div>
                    </div>

                    <!-- Ù‚Ø³Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                    <div class="student-list">
                        <h3>ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <div id="studentList" class="no-data">
                            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨...
                        </div>
                    </div>

                    <div class="nav-buttons">
                        <button class="btn-secondary" onclick="showSection('teacherLogin')">Ø±Ø¬ÙˆØ¹</button>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† -->
            <div id="lesson" class="section">
                <div class="student-info">
                    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:</h3>
                    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="displayStudentName"></span></p>
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</strong> <span id="displayExamNumber"></span></p>
                    <p><strong>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> <span id="displayRegistrationTime"></span></p>
                </div>
                
                <div class="start-screen">
                    <h2>ğŸ“š ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
                    <div class="info-box">
                        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</strong>
                        <div style="margin-top: 10px;">âœ“ 30 Ø³Ø¤Ø§Ù„ Ù…ØªÙ†ÙˆØ¹</div>
                        <div>âœ“ 30 Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ‚Øª</div>
                        <div>âœ“ Ù†Ø¸Ø§Ù… Ø®ØµÙ…</div>
                        <div>âœ“ ØªØ±ÙƒÙŠØ² Ø¶Ø±ÙˆØ±ÙŠ</div>
                    </div>
                    <div class="nav-buttons">
                        <button class="btn-primary" onclick="goToStart()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
                        <button class="btn-secondary" onclick="showSection('studentRegistration')">Ø±Ø¬ÙˆØ¹</button>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† -->
            <div id="startScreen" class="section">
                <div class="start-screen">
                    <h2>ğŸ“ Ù‡Ù„ Ø§Ù†Øª Ù…Ø³ØªØ¹Ø¯ØŸ</h2>
                    <div class="info-box">
                        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</strong>
                        <div style="margin-top: 10px;">âœ“ 30 Ø³Ø¤Ø§Ù„ Ù…ØªÙ†ÙˆØ¹</div>
                        <div>âœ“ 30 Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ‚Øª</div>
                        <div>âœ“ Ù†Ø¸Ø§Ù… Ø®ØµÙ…</div>
                        <div>âœ“ ØªØ±ÙƒÙŠØ² Ø¶Ø±ÙˆØ±ÙŠ</div>
                    </div>
                    <div class="nav-buttons">
                        <button class="btn-primary" onclick="startQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
                        <button class="btn-secondary" onclick="backToLesson()">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† -->
            <div id="quiz" class="section">
                <div class="timer-section">
                    <div>
                        <div style="font-size: 0.9em;">Ø§Ù„ÙˆÙ‚Øª:</div>
                        <div id="timer" class="timer">30:00</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.9em;">Ø§Ù„Ø¯Ø±Ø¬Ø©</div>
                        <div id="currentScore" style="font-size: 1.5em; font-weight: bold;">0</div>
                    </div>
                </div>
                
                <div class="progress">
                    <span id="progressText">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 30</span>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <div id="quizContainer"></div>
                
                <div id="results" style="display: none;">
                    <div class="score-board">
                        <h2 id="resultTitle">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
                        <p id="finalScore"></p>
                        <p id="scorePercentage"></p>
                    </div>
                    <div class="nav-buttons">
                        <button class="btn-secondary" onclick="showSection('studentRegistration')">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const allQuestions = [
            { type: "Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯", q: "Ù…Ø§Ø°Ø§ ØªØ±Ù…Ø² Ø£Ø³Ø·ÙˆØ±Ø© Ø¥ÙŠÙƒØ§Ø±ÙˆØ³ ÙÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·ÙŠØ±Ø§Ù†ØŸ", opts: ["Ø§Ù„Ø±ØºØ¨Ø© ÙÙŠ ÙƒØ³Ø± Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© ÙˆØ§Ù„Ø·Ù…ÙˆØ­ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠ Ù†Ø­Ùˆ Ø§Ù„Ø·ÙŠØ±Ø§Ù†", "Ø§Ù„Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø³Ù‚ÙˆØ· ÙˆØ§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ø§Ù„Ù…Ø®Ø§Ø·Ø±", "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·ÙŠØ±Ø§Ù† Ù„Ø£ØºØ±Ø§Ø¶ Ø¹Ø³ÙƒØ±ÙŠØ©", "Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ‚"], ans: 0 },
            { type: "Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯", q: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù…Ø®ØªØ±Ø¹ Ø§Ù„Ø°ÙŠ Ø±Ø³Ù… ØªØµØ§Ù…ÙŠÙ… Ø£ÙˆÙ„ÙŠØ© Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·ÙŠØ±Ø§Ù† Ø®Ù„Ø§Ù„ Ø¹ØµØ± Ø§Ù„Ù†Ù‡Ø¶Ø©ØŸ", opts: ["Ø¹Ø¨Ø§Ø³ Ø¨Ù† ÙØ±Ù†Ø§Ø³", "Ù„ÙŠÙˆÙ†Ø§Ø±Ø¯Ùˆ Ø¯Ø§ÙÙ†Ø´ÙŠ", "Ø±Ø§ÙŠØª Ø¨Ø±Ø§Ø²Ø±Ø²", "Ø§Ù„Ø£Ø®ÙˆØ§Ù† Ù…ÙˆÙ†ØºÙˆÙ„ÙÙŠÙŠÙ‡"], ans: 1 },
            // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        ];

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let questions = [];
        let currentQuestion = 0;
        let score = 0;
        let correct = 0;
        let wrong = 0;
        let timeLeft = 1800;
        let timerInterval = null;
        let answered = false;
        let studentAnswers = [];
        let currentStudent = null;

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
        const STORAGE_KEYS = {
            STUDENTS: 'exam_students_data',
            ACTIVE_STUDENTS: 'exam_active_students',
            TEACHER_SETTINGS: 'exam_teacher_settings'
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†
        function initializeStorage() {
            if (!localStorage.getItem(STORAGE_KEYS.STUDENTS)) {
                localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify([]));
            }
            if (!localStorage.getItem(STORAGE_KEYS.ACTIVE_STUDENTS)) {
                localStorage.setItem(STORAGE_KEYS.ACTIVE_STUDENTS, JSON.stringify([]));
            }
            if (!localStorage.getItem(STORAGE_KEYS.TEACHER_SETTINGS)) {
                localStorage.setItem(STORAGE_KEYS.TEACHER_SETTINGS, JSON.stringify({
                    autoRefresh: false,
                    lastLogin: null
                }));
            }
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
        function getStudentsData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDENTS)) || [];
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
        function saveStudentsData(data) {
            localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(data));
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
        function getActiveStudents() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVE_STUDENTS)) || [];
        }

        // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
        function saveActiveStudents(data) {
            localStorage.setItem(STORAGE_KEYS.ACTIVE_STUDENTS, JSON.stringify(data));
        }

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³
        const teacherCredentials = {
            username: "teacher",
            password: "123456"
        };

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'teacherPanel') {
                updateTeacherPanel();
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
        function registerStudent() {
            const studentName = document.getElementById('studentName').value.trim();
            const examNumber = document.getElementById('examNumber').value;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!studentName) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„');
                return;
            }

            if (!examNumber || examNumber <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù…ØªØ­Ø§Ù† ØµØ­ÙŠØ­');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
            const studentsData = getStudentsData();
            const isDuplicate = studentsData.some(student => student.examNumber == examNumber);
            if (isDuplicate) {
                alert('Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }

            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
            currentStudent = {
                name: studentName,
                examNumber: examNumber,
                startTime: new Date().toISOString(),
                sessionId: Date.now().toString() + Math.random().toString(36).substr(2, 9)
            };

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
            const activeStudents = getActiveStudents();
            const activeStudent = {
                ...currentStudent,
                currentQuestion: 0,
                timeLeft: 1800,
                score: 0,
                status: 'registered',
                lastUpdate: new Date().toISOString(),
                ipAddress: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© IP Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
            };
            
            activeStudents.push(activeStudent);
            saveActiveStudents(activeStudents);

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­
            updateDebugInfo(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName} (Ø±Ù‚Ù…: ${examNumber})`);

            // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
            document.getElementById('displayStudentName').textContent = studentName;
            document.getElementById('displayExamNumber').textContent = examNumber;
            document.getElementById('displayRegistrationTime').textContent = new Date().toLocaleString('ar-EG');

            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
            showSection('lesson');
        }

        // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³
        function teacherLogin() {
            const username = document.getElementById('teacherUsername').value;
            const password = document.getElementById('teacherPassword').value;
            
            if (username === teacherCredentials.username && password === teacherCredentials.password) {
                // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                const teacherSettings = JSON.parse(localStorage.getItem(STORAGE_KEYS.TEACHER_SETTINGS));
                teacherSettings.lastLogin = new Date().toISOString();
                localStorage.setItem(STORAGE_KEYS.TEACHER_SETTINGS, JSON.stringify(teacherSettings));
                
                showSection('teacherPanel');
                updateDebugInfo('ØªÙ… Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³
        function updateTeacherPanel() {
            updateTeacherSessionInfo();
            updateStudentsList();
            updateActiveStudentsList();
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø¯Ø±Ø³
        function updateTeacherSessionInfo() {
            document.getElementById('teacherLastUpdate').textContent = new Date().toLocaleString('ar-EG');
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
        function updateActiveStudentsList() {
            const activeStudentsList = document.getElementById('activeStudentsList');
            const activeStudents = getActiveStudents();
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚ØªÙ‡Ù… Ø£Ùˆ Ø§Ù†ØªÙ‡ÙˆØ§
            const now = new Date();
            const cleanedActiveStudents = activeStudents.filter(student => {
                const lastUpdate = new Date(student.lastUpdate);
                const timeDiff = (now - lastUpdate) / 1000; // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ù… Ù„Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚
                if (timeDiff > 300) {
                    return false;
                }

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚ØªÙ‡Ù…
                if (student.timeLeft <= 0) {
                    return false;
                }

                return true;
            });

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©
            if (cleanedActiveStudents.length !== activeStudents.length) {
                saveActiveStudents(cleanedActiveStudents);
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            document.getElementById('activeStudentsCount').textContent = `(${cleanedActiveStudents.length})`;

            if (cleanedActiveStudents.length === 0) {
                activeStudentsList.innerHTML = '<div class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                return;
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
            let html = '';
            cleanedActiveStudents.forEach((student, index) => {
                const minutes = Math.floor(student.timeLeft / 60);
                const seconds = student.timeLeft % 60;
                const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                const progressPercent = (student.currentQuestion / 30) * 100;

                html += `
                    <div class="student-card active-student-card">
                        <h4>ğŸ”´ ${student.name} (Ø±Ù‚Ù…: ${student.examNumber})</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                            <p><strong>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> ${student.currentQuestion}/30</p>
                            <p><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> <span class="timer ${student.timeLeft <= 600 ? 'warning' : ''} ${student.timeLeft <= 60 ? 'danger' : ''}">${timeString}</span></p>
                            <p><strong>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> ${student.score.toFixed(1)}</p>
                            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${student.status === 'in_progress' ? 'ÙŠØ­Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†' : 'Ù…Ø³Ø¬Ù„'}</p>
                        </div>
                        <div style="background: #e0e0e0; height: 6px; border-radius: 3px; margin: 10px 0; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${progressPercent}%;"></div>
                        </div>
                        <div class="student-actions">
                            <button class="btn-success" onclick="addTime(${index}, 300)">â• +5 Ø¯Ù‚Ø§Ø¦Ù‚</button>
                            <button class="btn-warning" onclick="subtractTime(${index}, 300)">â– -5 Ø¯Ù‚Ø§Ø¦Ù‚</button>
                            <button class="btn-danger" onclick="endStudentExam(${index})">ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
                        </div>
                    </div>
                `;
            });

            activeStudentsList.innerHTML = html;
            updateDebugInfo(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${cleanedActiveStudents.length} Ø·Ø§Ù„Ø¨ Ù†Ø´Ø·`);
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
        function updateStudentsList() {
            const studentList = document.getElementById('studentList');
            const studentsData = getStudentsData();

            if (studentsData.length === 0) {
                studentList.innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯</div>';
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('averageScore').textContent = '0%';
                document.getElementById('highestScore').textContent = '0%';
                document.getElementById('lowestScore').textContent = '0%';
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('totalStudents').textContent = studentsData.length;

            const scores = studentsData.map(student => student.score || 0);
            const averageScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
            document.getElementById('averageScore').textContent = Math.round(averageScore) + '%';
            document.getElementById('highestScore').textContent = scores.length > 0 ? Math.max(...scores) + '%' : '0%';
            document.getElementById('lowestScore').textContent = scores.length > 0 ? Math.min(...scores) + '%' : '0%';

            // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
            let html = '';
            studentsData.forEach((student, index) => {
                html += `
                    <div class="student-card">
                        <h4>${student.name} (Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: ${student.examNumber})</h4>
                        <p><strong>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> ${student.score || 0}%</p>
                        <p><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©:</strong> ${student.correctAnswers || 0} Ù…Ù† 30</p>
                        <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${student.timeTaken || '00:00'}</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</strong> ${student.endTime ? new Date(student.endTime).toLocaleString('ar-EG') : 'Ù„Ù… ÙŠÙƒÙ…Ù„'}</p>
                    </div>
                `;
            });

            studentList.innerHTML = html;
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            debugElement.innerHTML = `[${timestamp}] ${message}<br>${debugElement.innerHTML}`;
        }

        // Ø¥Ø¶Ø§ÙØ© ÙˆÙ‚Øª Ù„Ù„Ø·Ø§Ù„Ø¨
        function addTime(index, seconds) {
            const activeStudents = getActiveStudents();
            if (activeStudents[index]) {
                activeStudents[index].timeLeft += seconds;
                activeStudents[index].lastUpdate = new Date().toISOString();
                saveActiveStudents(activeStudents);
                updateActiveStudentsList();
                updateDebugInfo(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${seconds / 60} Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ ${activeStudents[index].name}`);
            }
        }

        // ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø·Ø§Ù„Ø¨
        function subtractTime(index, seconds) {
            const activeStudents = getActiveStudents();
            if (activeStudents[index]) {
                activeStudents[index].timeLeft = Math.max(0, activeStudents[index].timeLeft - seconds);
                activeStudents[index].lastUpdate = new Date().toISOString();
                saveActiveStudents(activeStudents);
                updateActiveStudentsList();
                updateDebugInfo(`ØªÙ… ØªÙ‚Ù„ÙŠÙ„ ${seconds / 60} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${activeStudents[index].name}`);
            }
        }

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
        function endStudentExam(index) {
            const activeStudents = getActiveStudents();
            if (activeStudents[index]) {
                const student = activeStudents[index];
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø·Ø§Ù„Ø¨
                const studentsData = getStudentsData();
                const studentResult = {
                    name: student.name,
                    examNumber: student.examNumber,
                    startTime: student.startTime,
                    score: Math.round((student.score / 30) * 100),
                    correctAnswers: Math.round(student.score),
                    wrongAnswers: 30 - Math.round(student.score),
                    finalScore: student.score.toFixed(1),
                    timeTaken: formatTime(1800 - student.timeLeft),
                    endTime: new Date().toISOString(),
                    sessionId: student.sessionId
                };

                studentsData.push(studentResult);
                saveStudentsData(studentsData);

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
                activeStudents.splice(index, 1);
                saveActiveStudents(activeStudents);

                updateTeacherPanel();
                updateDebugInfo(`ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.name}`);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
        function refreshActiveStudents() {
            updateActiveStudentsList();
            updateTeacherSessionInfo();
            updateDebugInfo('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹');
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function startAutoRefresh() {
            setInterval(() => {
                refreshActiveStudents();
            }, 3000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù
            updateDebugInfo('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
            alert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù');
        }

        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function exportData() {
            const studentsData = getStudentsData();
            const activeStudents = getActiveStudents();
            
            const data = {
                students: studentsData,
                activeStudents: activeStudents,
                exportTime: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'exam_data.json';
            link.click();
            URL.revokeObjectURL(url);
            
            updateDebugInfo('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        // Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function clearAllData() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.')) {
                localStorage.removeItem(STORAGE_KEYS.STUDENTS);
                localStorage.removeItem(STORAGE_KEYS.ACTIVE_STUDENTS);
                initializeStorage();
                updateTeacherPanel();
                updateDebugInfo('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
        function goToStart() {
            showSection('startScreen');
        }

        function backToLesson() {
            showSection('lesson');
        }

        function startQuiz() {
            if (!currentStudent) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†');
                showSection('studentRegistration');
                return;
            }

            // ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            questions = [...allQuestions].sort(() => Math.random() - 0.5);
            currentQuestion = 0;
            score = 0;
            correct = 0;
            wrong = 0;
            timeLeft = 1800;
            answered = false;
            studentAnswers = [];

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù†Ø´Ø·
            const activeStudents = getActiveStudents();
            const activeStudentIndex = activeStudents.findIndex(student => student.sessionId === currentStudent.sessionId);
            if (activeStudentIndex !== -1) {
                activeStudents[activeStudentIndex].status = 'in_progress';
                activeStudents[activeStudentIndex].currentQuestion = 0;
                activeStudents[activeStudentIndex].timeLeft = 1800;
                activeStudents[activeStudentIndex].score = 0;
                activeStudents[activeStudentIndex].lastUpdate = new Date().toISOString();
                saveActiveStudents(activeStudents);
            }

            showSection('quiz');

            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
                const activeStudents = getActiveStudents();
                const activeStudentIndex = activeStudents.findIndex(student => student.sessionId === currentStudent.sessionId);
                if (activeStudentIndex !== -1) {
                    activeStudents[activeStudentIndex].timeLeft = timeLeft;
                    activeStudents[activeStudentIndex].lastUpdate = new Date().toISOString();
                    saveActiveStudents(activeStudents);
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endQuiz();
                }
            }, 1000);

            displayQuestion();
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 600) timerEl.classList.add('warning');
            if (timeLeft <= 60) {
                timerEl.classList.remove('warning');
                timerEl.classList.add('danger');
            }
        }

        function displayQuestion() {
            if (currentQuestion >= questions.length) {
                endQuiz();
                return;
            }
            
            answered = false;
            const q = questions[currentQuestion];
            const progressPercent = (currentQuestion / questions.length) * 100;
            
            document.getElementById('progressBar').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestion + 1} Ù…Ù† ${questions.length}`;
            document.getElementById('currentScore').textContent = score.toFixed(1);
            
            let html = `<div class="quiz-question"><div class="question-type">${q.type}</div><h3>${q.q}</h3><div class="options">`;
            
            q.opts.forEach((opt, idx) => {
                html += `<div class="option" onclick="selectOpt(${idx})">${opt}</div>`;
            });
            
            html += `</div><div class="nav-buttons"><button class="btn-primary" id="nextBtn" onclick="nextQ()" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button></div></div>`;
            
            document.getElementById('quizContainer').innerHTML = html;
        }

        function selectOpt(idx) {
            if (answered) return;
            answered = true;

            const opts = document.querySelectorAll('.option');
            opts.forEach(o => o.classList.add('disabled'));

            const q = questions[currentQuestion];
            const nextBtn = document.getElementById('nextBtn');

            // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            studentAnswers.push({
                questionIndex: currentQuestion,
                selected: idx,
                correct: idx === q.ans
            });

            if (idx === q.ans) {
                opts[idx].classList.add('correct');
                score += 1;
                correct++;
            } else {
                opts[idx].classList.add('incorrect');
                opts[q.ans].classList.add('correct');
                score -= 0.5;
                wrong++;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
            const activeStudents = getActiveStudents();
            const activeStudentIndex = activeStudents.findIndex(student => student.sessionId === currentStudent.sessionId);
            if (activeStudentIndex !== -1) {
                activeStudents[activeStudentIndex].score = score;
                activeStudents[activeStudentIndex].currentQuestion = currentQuestion + 1;
                activeStudents[activeStudentIndex].lastUpdate = new Date().toISOString();
                saveActiveStudents(activeStudents);
            }

            document.getElementById('currentScore').textContent = score.toFixed(1);
            nextBtn.disabled = false;
        }

        function nextQ() {
            currentQuestion++;
            displayQuestion();
        }

        function endQuiz() {
            if (timerInterval) clearInterval(timerInterval);

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            const finalScore = Math.max(0, score);
            const percentage = Math.round((finalScore / 30) * 100);

            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
            if (currentStudent) {
                const studentsData = getStudentsData();
                const studentResult = {
                    ...currentStudent,
                    score: percentage,
                    correctAnswers: correct,
                    wrongAnswers: wrong,
                    finalScore: finalScore.toFixed(1),
                    timeTaken: formatTime(1800 - timeLeft),
                    endTime: new Date().toISOString(),
                    answers: studentAnswers
                };

                studentsData.push(studentResult);
                saveStudentsData(studentsData);

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
                const activeStudents = getActiveStudents();
                const activeStudentIndex = activeStudents.findIndex(student => student.sessionId === currentStudent.sessionId);
                if (activeStudentIndex !== -1) {
                    activeStudents.splice(activeStudentIndex, 1);
                    saveActiveStudents(activeStudents);
                }
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            document.getElementById('finalScore').textContent = `Ø¯Ø±Ø¬ØªÙƒ: ${finalScore.toFixed(1)} Ù…Ù† 30`;
            document.getElementById('scorePercentage').textContent = `Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: ${percentage}%`;

            if (percentage >= 90) document.getElementById('resultTitle').innerHTML = 'ğŸ† Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹!';
            else if (percentage >= 80) document.getElementById('resultTitle').innerHTML = 'ğŸ–ï¸ Ù…Ù…ØªØ§Ø²!';
            else if (percentage >= 70) document.getElementById('resultTitle').innerHTML = 'ğŸ‘ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹!';
            else if (percentage >= 60) document.getElementById('resultTitle').innerHTML = 'ğŸ‘Œ Ø¬ÙŠØ¯!';
            else document.getElementById('resultTitle').innerHTML = 'ğŸ’ª Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!';
        }

        // ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.addEventListener('load', function() {
            initializeStorage();
            updateDebugInfo('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
        });
    </script>
</body>
</html>
